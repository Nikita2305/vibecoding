## Техническое задание: генератор вертикального анимированного видео “маршрут по миру” (self-hosted, вариант 1)

### 1) Цель

Сделать self-hosted сервис/CLI, который по списку точек путешествия (City/Country) и типу перемещения между ними (train/car/plane) генерирует **вертикальный MP4** с красивой анимацией: объект (поезд/машина/самолёт) движется по глобусу между городами, а при прибытии над городом появляется табличка с названием.

---

### 2) Входные данные

#### 2.1 Формат

Поддержать **JSON** (обязательно) и **CSV** (опционально).

**JSON (основной):**

```json
{
  "video": {
    "duration_sec": 45,
    "fps": 30,
    "resolution": "1080x1920",
    "map_style": "dark",
    "language": "ru"
  },
  "route": [
    {"city": "Warsaw", "country": "Poland"},
    {"city": "Berlin", "country": "Germany", "transport": "train"},
    {"city": "Paris", "country": "France", "transport": "plane"},
    {"city": "Lyon", "country": "France", "transport": "car"}
  ]
}
```

Правила:

* `route[0]` — стартовая точка без `transport`.
* Для `route[i]` (i>0) поле `transport` описывает **как доехал от route[i-1] до route[i]**.
* `transport` ∈ {`plane`, `train`, `car`}.

**CSV (если делаете):**

* Колонки: `city,country,transport`
* Первая строка может иметь пустой `transport`.

#### 2.2 Параметры генерации (конфиг)

Минимальный набор:

* `duration_sec` (обяз.) — длина итогового видео. Определяет скорость анимации.
* `fps` (по умолчанию 30)
* `resolution` (по умолчанию 1080x1920)
* `map_style` (по умолчанию dark)
* `language` (для локализации подписей, по умолчанию ru)

Опционально:

* `hold_sec` — пауза “в городе” (по умолчанию 0.8с)
* `label_show_sec` / `label_hide_sec` (плавность таблички)
* `path_color_by_transport` (если захотите)

---

### 3) Выходные данные

#### 3.1 Формат

* MP4 (H.264), вертикальный, `resolution` x `fps`.
* Аудио не требуется (опционально добавляется потом).

#### 3.2 Визуальные требования

* Глобус/карта в 3D-впечатлении (допускается “псевдо-глобус”: сфера/проекция, но визуально — «по земному шару»).
* Между городами рисуется маршрут (дуга/линия) и по нему движется соответствующий объект:

  * `plane` — самолёт по дуге (great-circle), выше “поверхности”
  * `train` — поезд по линии (можно по дуге, но визуально ближе к поверхности)
  * `car` — машина по линии ближе к поверхности
* В момент прибытия:

  * над городом появляется табличка с названием `City, Country`
  * табличка “загорается” (анимация свечения/подсветки) и держится `hold_sec`

---

### 4) Логика таймингов (скорость от длины видео)

#### 4.1 Общая модель

Видео состоит из N сегментов перемещения (N = количество переездов = `len(route)-1`) и N+1 остановок (старт и прибытия).

Распределение длительности:

* `T_total = duration_sec`
* `T_hold = hold_sec * (len(route))` (остановка в каждом городе, включая старт — или только прибытия, выбрать один вариант и зафиксировать)
* `T_move = T_total - T_hold`

Если `T_move <= 0`:

* уменьшить `hold_sec` автоматически до допустимого или выдать ошибку валидации (предпочтительно — ошибка с подсказкой).

#### 4.2 Распределение времени между сегментами

Базово: пропорционально длине маршрута (геодезическое расстояние).

* Для сегмента i:

  * `d_i = distance_km(point[i-1], point[i])`
  * `t_i = T_move * (d_i / sum(d))`
    Ограничения:
* `t_i` не меньше `t_min` (например 1.2с), иначе перераспределить остаток.
* `t_i` не больше `t_max` (например 12с) — опционально.

---

### 5) Геокодинг (City/Country → координаты)

#### 5.1 Требование

Сервис обязан получать координаты (lat/lon) для каждой точки.

#### 5.2 Реализация

* Поддержать провайдер геокодинга как интерфейс:

  * `Geocoder.geocode(city, country) -> {lat, lon, display_name}`
* Варианты:

  * онлайн (например Nominatim/Mapbox Geocoding) — если доступно
  * оффлайн-кеш (локальный файл `geocode_cache.json`)

#### 5.3 Кеширование

* Результат геокодинга кешировать по ключу `city|country|language`.
* При повторных генерациях сетевых запросов быть не должно.

#### 5.4 Валидация

* Если точка не геокодится — ошибка с указанием проблемной строки и предложением уточнить (например добавить регион).

---

### 6) Построение маршрута

#### 6.1 Геометрия

* Для `plane`: **great-circle arc** (дуга по сфере).
* Для `car/train`: допускается

  1. great-circle по поверхности (упрощение) **или**
  2. реальный роутинг по дорогам/жд (сложно; не обязателен в MVP)

В MVP: все типы используют great-circle, но **разная высота/стиль**.

#### 6.2 Визуальные отличия транспортов

* `plane`: дуга выше, скорость визуально выше, лёгкий “след/шлейф”
* `train`: ближе к поверхности, плавное движение, можно добавить “пульс” линии
* `car`: ближе к поверхности, чуть более “неровный” easing (легкая вариативность скорости — опционально)

---

### 7) Камера и сцены

#### 7.1 Камера

Требования:

* Камера следует за движением, удерживая в кадре текущий транспорт и траекторию.
* При прибытии — мягкий зум/пан на город для таблички.

MVP-правило:

* Перед началом сегмента камера центрируется между A и B.
* Во время движения камера слегка следует за объектом.
* На stop — камера фокусируется на B.

#### 7.2 Компоновка вертикального видео

* 9:16, безопасные поля сверху/снизу (чтобы табличка не резалась).
* Название города появляется над точкой (не в самом верху).

---

### 8) Табличка города (“подсветка”)

#### 8.1 Контент

* Текст: `City, Country` (или только City — опцией).
* Шрифт: один системный/вендорный (в репозитории).

#### 8.2 Анимация

* Fade + scale-in (например 0.25–0.35s).
* “Glow” (свечение) на 0.2s при появлении и легкое пульсирование во время hold (опционально).
* Fade-out перед началом следующего сегмента (0.2–0.3s).

#### 8.3 Коллизии

Если табличка выходит за экран:

* сдвигать вниз/вверх
* либо менять якорь (лево/право)

---

### 9) Технологический стек и архитектура

#### 9.1 Компоненты

1. **Renderer (Web)**: Node.js + WebGL

   * Mapbox GL JS как базовый рендер карты/глобуса
   * deck.gl для анимируемых слоёв (маршрут/след/точки)
   * дополнительный слой (canvas/SVG) для иконки транспорта и табличек

2. **Frame Capturer**:

   * Puppeteer (headless Chromium)
   * покадровый рендер: `frame_000001.png`, …

3. **Video Encoder**:

   * ffmpeg склейка PNG → MP4

4. **CLI/Service**:

   * `generate --input route.json --out out.mp4`
   * Логи только в консоль

#### 9.2 Конфигурация

* `.env` для токенов (Mapbox token, если нужен)
* `config.json` для дефолтов

#### 9.3 Структура проекта (рекоменд.)

* `/app` — web renderer (страница, скрипты)
* `/cli` — запуск пайплайна, валидация, геокодинг, кеш
* `/assets` — иконки транспорта, шрифты
* `/output` — кадры/видео (в gitignore)

---

### 10) Алгоритм генерации (пайплайн)

1. Прочитать input → валидировать schema
2. Геокодинг всех точек → кеш
3. Посчитать distances → тайминги сегментов
4. Сгенерировать “таймлайн” (массив ключевых событий: start/arrive/showLabel/hideLabel)
5. Запустить headless renderer:

   * передать таймлайн и координаты в страницу
6. Для `frame = 0..fps*duration_sec-1`:

   * выставить `t = frame/fps`
   * отрендерить сцену в canvas/WebGL
   * снять скриншот кадра
7. ffmpeg: собрать MP4
8. Очистить кадры (опционально флаг `--keep-frames`)

---

### 11) Требования к качеству и производительности

* Рендер должен быть **детерминированным** (один input → один output).
* Поддержка минимум:

  * `duration_sec`: 10–180
  * количество городов: 2–50 (MVP: до 25)
* Генерация допускается оффлайн после геокод-кеша (кроме подгрузки тайлов карты; в идеале иметь локальный стиль/тайлы, но это уже v2).

---

### 12) Ошибки и сообщения

* Некорректный JSON/CSV → “Invalid input format”
* Неизвестный `transport` → “Unsupported transport at row i”
* Геокодинг не найден → “Geocode failed for City/Country”
* `duration_sec` слишком маленькая под holds → “Duration too short; increase duration or decrease hold_sec”
* Все ошибки должны содержать: индекс точки/сегмента, входное значение, рекомендацию.

---

### 13) Критерии приемки (Definition of Done)

1. По тестовому JSON из 5 городов генерируется MP4 1080x1920, 30fps, заданной длительности.
2. Скорость движения меняется при изменении `duration_sec` (при прочих равных).
3. В каждом сегменте едет корректный объект (plane/train/car).
4. На каждом прибытии появляется табличка с названием города (анимация появления + подсветка).
5. Видео выглядит “цельно”: нет рывков камеры, нет перескоков объекта.
6. Логи только в консоль, артефакты в `output/`.

---

### 14) Не входит в MVP (явно исключить)

* Реальный роутинг по дорогам/жд путям (OSRM/GraphHopper/железнодорожные графы)
* Звук/музыка
* Веб-интерфейс для пользователя (только CLI/локальный сервис)
* Мульти-темплейты дизайна (1 аккуратный стиль достаточно)

---

### 15) Примеры CLI (требуемые команды)

* `travelvid generate --input route.json --out out.mp4`
* `travelvid generate --input route.json --out out.mp4 --duration 60 --fps 60`
* `travelvid geocode-cache --input route.json` (опционально)
